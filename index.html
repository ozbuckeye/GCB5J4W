<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elevation Puzzle</title>
</head>
<body>
  <h1>Geocaching Puzzle</h1>
  <p id="status">Checking your elevation...</p>

  <script>
    const targetElevation = 300;

    // AES-GCM encrypted coordinates with base64 encoding
    const encryptedData = {
      ciphertext: "a7hclw8CRgnXhHTkArqAORWmvRCS0EFYHx+FWCsw1Ns=",  // Example output from previous step
      iv: "XxYBdQaGVdh3DFxp"  // Base64 IV
    };

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    async function decryptText(ciphertextBase64, ivBase64, password) {
      const enc = new TextEncoder();
      const keyMaterial = await window.crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        "PBKDF2",
        false,
        ["deriveKey"]
      );

      const salt = new Uint8Array([0, 1, 2, 3, 4, 5, 6, 7]); // Static salt
      const key = await window.crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: salt,
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
      );

      const decrypted = await window.crypto.subtle.decrypt(
        {
          name: "AES-GCM",
          iv: base64ToArrayBuffer(ivBase64)
        },
        key,
        base64ToArrayBuffer(ciphertextBase64)
      );

      return new TextDecoder().decode(decrypted);
    }

    navigator.geolocation.getCurrentPosition(success, error, {
      enableHighAccuracy: true
    });

    function success(position) {
      const altitude = position.coords.altitude;
      const status = document.getElementById("status");

      if (altitude === null) {
        status.innerHTML = "‚ö†Ô∏è Elevation not available. Try a device with better GPS.";
        return;
      }

      if (altitude === 0) {
        status.innerHTML = "üì± If you are using a laptop or desktop, your elevation is likely not being recorded. Try using a mobile device.";
        return;
      }

      if (altitude >= targetElevation) {
        decryptText(encryptedData.ciphertext, encryptedData.iv, "elevation300")
          .then(coords => {
            status.innerHTML = `‚úÖ You are at ${Math.round(altitude)}m elevation.<br>Your coordinates are:<br><strong>${coords}</strong>`;
          })
          .catch(() => {
            status.innerHTML = "‚ùå Failed to decrypt coordinates.";
          });
      } else {
        status.innerHTML = `‚¨ÜÔ∏è You're at ${Math.round(altitude)}m ‚Äî keep climbing to at least ${targetElevation}m!`;
      }
    }

    function error(err) {
      document.getElementById("status").textContent = "‚ö†Ô∏è Error getting location: " + err.message;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elevation Puzzle</title>
</head>
<body>
  <h1>Geocaching Puzzle</h1>
  <p id="status">Checking your elevation...</p>

  <script>
    const targetElevation = 300;

    // Encrypted payload
    const encryptedData = {
      iv: "ztNHzlROVfjk3qnzT3DZ0g==",
      ciphertext: "vhDRaZTpnGk7QZrUAhKDb37Z6RQX2sb2Ge5/NAsAqJ4="
    };

    async function getKeyFromPassphrase(passphrase) {
      const encoder = new TextEncoder();
      const keyMaterial = await window.crypto.subtle.importKey(
        "raw",
        encoder.encode(passphrase),
        { name: "PBKDF2" },
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt: encoder.encode("staticSalt123"), // can be any string
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
      );
    }

    async function decryptText(ciphertextBase64, ivBase64, passphrase) {
      const decoder = new TextDecoder();
      const ciphertext = Uint8Array.from(atob(ciphertextBase64), c => c.charCodeAt(0));
      const iv = Uint8Array.from(atob(ivBase64), c => c.charCodeAt(0));
      const key = await getKeyFromPassphrase(passphrase);

      const decrypted = await window.crypto.subtle.decrypt(
        {
          name: "AES-GCM",
          iv: iv
        },
        key,
        ciphertext
      );

      return decoder.decode(decrypted);
    }

    // Check elevation
    navigator.geolocation.getCurrentPosition(async function success(position) {
      const altitude = position.coords.altitude;
      const status = document.getElementById("status");

      if (altitude === null) {
        status.innerHTML = "⚠️ Elevation not available. Try a device with better GPS.";
        return;
      }

      if (altitude >= targetElevation) {
        try {
          const coords = await decryptText(encryptedData.ciphertext, encryptedData.iv, "elevation300");
          status.innerHTML = `✅ You are at ${Math.round(altitude)}m elevation.<br>Your coordinates are:<br><strong>${coords}</strong>`;
        } catch (err) {
          status.innerHTML = "❌ Failed to decrypt coordinates.";
        }
      } else {
        status.innerHTML = `⬆️ You're at ${Math.round(altitude)}m — keep climbing to at least ${targetElevation}m!`;
      }
    }, function error(err) {
      document.getElementById("status").textContent = "⚠️ Error getting location: " + err.message;
    }, {
      enableHighAccuracy: true
    });
  </script>
</body>
</html>
